<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>G2KO - Gene to KEGG KO Extractor</title>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f4f7fa;
    margin: 40px;
}

.container {
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    max-width: 900px;
    margin: auto;
}

h1 {
    text-align: center;
}

input {
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    margin-bottom: 10px;
    width: 45%;
}

button {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    background: #007bff;
    color: white;
    cursor: pointer;
}

button:hover {
    background: #0056b3;
}

textarea {
    width: 100%;
    height: 300px;
    margin-top: 20px;
    border-radius: 6px;
}

.progress {
    margin-top: 15px;
    font-weight: bold;
}

.link-box {
    margin-top: 20px;
    padding: 12px;
    background: #e8f2ff;
    border-radius: 6px;
}
</style>
</head>

<body>

<div class="container">
<h1>G2KO - Gene to KEGG KO Extractor</h1>

<div id="organisms"></div>

<button onclick="addOrganism()">Add Organism</button>
<button onclick="fetchData()">Fetch KO Data</button>

<div class="progress" id="progress"></div>

<textarea id="output" placeholder="Results will appear here..."></textarea>

<button onclick="downloadFile()">Download TXT</button>

<div class="link-box">
After downloading, open  
<a href="https://www.genome.jp/kegg/mapper/reconstruct.html" target="_blank">
KEGG Reconstruct Mapper
</a>
</div>

</div>

<script>

let organismCount = 0;
let outputText = "";

function addOrganism() {
    organismCount++;
    const div = document.createElement("div");
    div.innerHTML = `
        <input type="text" id="code${organismCount}" placeholder="KEGG Code (e.g., eco)">
        <input type="text" id="name${organismCount}" placeholder="Organism Name (Optional)">
    `;
    document.getElementById("organisms").appendChild(div);
}

async function fetchData() {

    outputText = "";
    document.getElementById("output").value = "";
    document.getElementById("progress").innerText = "Loading KO database...";

    // Load KO function database
    const koResponse = await fetch("https://rest.kegg.jp/list/ko");
    const koText = await koResponse.text();
    const koLines = koText.split("\n");

    let koDict = {};
    koLines.forEach(line => {
        const parts = line.split("\t");
        if(parts.length >= 2) {
            const koId = parts[0].split(":")[1];
            koDict[koId] = parts[1];
        }
    });

    let total = organismCount;

    for(let i = 1; i <= organismCount; i++) {

        let code = document.getElementById(`code${i}`).value.trim();
        let name = document.getElementById(`name${i}`).value.trim();

        if(!code) continue;

        if(!name) name = "Organism " + i;

        document.getElementById("progress").innerText = 
            `Processing ${i} of ${total} (${Math.round((i/total)*100)}%)`;

        const response = await fetch(`https://rest.kegg.jp/link/ko/${code}`);

        if(!response.ok) {
            alert("Invalid KEGG code: " + code);
            continue;
        }

        const text = await response.text();
        const lines = text.split("\n");

        outputText += "# " + name + "\n";

        lines.forEach(line => {
            const parts = line.split("\t");
            if(parts.length == 2) {
                const gene = parts[0].split(":")[1];
                const ko = parts[1].split(":")[1];
                const func = koDict[ko] || "Function not found";
                outputText += gene + "\t" + ko + "\t" + func + "\n";
            }
        });

        outputText += "\n";
    }

    document.getElementById("progress").innerText = "Complete âœ…";
    document.getElementById("output").value = outputText;
}

function downloadFile() {
    const blob = new Blob([outputText], {type: "text/plain"});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "g2ko_output.txt";
    link.click();
}

// Add first organism automatically
addOrganism();

</script>

</body>
</html>
